task _copyArtifacts {
    dependsOn 'copyDockerFiles'
    doLast {
        configurations.docker.setTransitive(false).resolvedConfiguration.resolvedArtifacts
            .each { artifact ->
            copy {
                from artifact.file
                into "${buildDir}/artifacts"
                rename { "${artifact.name}.${artifact.extension}" }
            }
            copy {
                from "${buildDir}/artifacts/jobroom.war"
                into "${buildDir}/docker/dockerfiles/jobroom"
            }
            copy {
                from "${buildDir}/artifacts/jobservice.jar"
                into "${buildDir}/docker/dockerfiles/jobservice"
            }
            copy {
                from "${buildDir}/artifacts/referenceservice.jar"
                into "${buildDir}/docker/dockerfiles/referenceservice"
            }
        }
    }
}

task cleanupRepo(type:Delete) { 
    delete '/home/ubuntu/.m2/repository/ch/'
}

task copyArtifacts {
    dependsOn 'copyDockerFiles', 'cleanupRepo'
    doLast {
        exec {
            commandLine 'rm', '-Rf', "~/.m2/repository/ch/"
        }
        exec {
            commandLine 'mvn', '-q', 'dependency:get', '-DrepoUrl=https://alvch.jfrog.io/alvch/libs-snapshots-local/', '-Dartifact=ch.admin.seco.jobroom:jobroom:LATEST:war', '-Dtransitive=false', "-Ddest=${buildDir}/docker/dockerfiles/jobroom/jobroom.war"
	}
        exec {
            commandLine 'mvn', '-q', 'dependency:get', '-DrepoUrl=https://alvch.jfrog.io/alvch/libs-snapshots-local/', '-Dartifact=ch.admin.seco.service.job:jobservice:LATEST:jar', '-Dtransitive=false', "-Ddest=${buildDir}/docker/dockerfiles/jobservice/jobservice.jar"
	}
        exec {
            commandLine 'mvn', '-q', 'dependency:get', '-DrepoUrl=https://alvch.jfrog.io/alvch/libs-snapshots-local/', '-Dartifact=ch.admin.seco.service.reference:referenceservice:LATEST:jar', '-Dtransitive=false', "-Ddest=${buildDir}/docker/dockerfiles/referenceservice/referenceservice.jar"
	}
    }
}

task copyDockerFiles {
    doLast {
        copy {
            from 'src/main/devops'
            into "${buildDir}/docker"
        }
    }
}

task build(type: Exec) {
    dependsOn 'copyArtifacts'
    commandLine 'docker-compose', '-f', "${buildDir}/docker/docker-compose.yml", 'build'
}

task deploy(type: Exec) {
    dependsOn 'build'
    commandLine 'docker-compose', '-f', "${buildDir}/docker/docker-compose.yml", 'up', '-d'
}

task stop(type: Exec) {
    commandLine 'docker-compose', '-f', "${buildDir}/docker/docker-compose.yml", 'stop'
}

task clean(type: Delete) {
    delete buildDir
}

logger.quiet('INFO:  Elasticsearch requires max virtual memory areas vm.max_map_count of at least [262144]')
logger.quiet('INFO:  run  "sudo sysctl -w vm.max_map_count=262144"  to prepare system')
